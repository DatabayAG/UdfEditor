<?php

use srag\DIC\UdfEditor\DICTrait;
use srag\Notifications4Plugin\UdfEditor\Notification\NotificationInterface;
use srag\Notifications4Plugin\UdfEditor\Utils\Notifications4PluginTrait;

class xudfSetting extends ActiveRecord
{
    use DICTrait;
    use Notifications4PluginTrait;
    public const PLUGIN_CLASS_NAME = ilUdfEditorPlugin::class;
    public const DB_TABLE_NAME = 'xudf_setting';

    public const REDIRECT_STAY_IN_FORM = 'stay_in_form';
    public const REDIRECT_TO_ILIAS_OBJECT = 'to_ilias_object';
    public const REDIRECT_TO_URL = 'to_url';

    public function getConnectorContainerName()
    {
        return self::DB_TABLE_NAME;
    }

    /**
     * @var int
     *
     * @con_has_field    true
     * @con_fieldtype    integer
     * @con_length       8
     * @con_is_notnull   true
     * @con_is_primary   true
     */
    protected $obj_id;
    /**
     * @var bool
     *
     * @con_has_field    true
     * @con_fieldtype    integer
     * @con_length       1
     * @con_is_notnull   true
     */
    protected $is_online = false;
    /**
     * @var bool
     *
     * @con_has_field    true
     * @con_fieldtype    integer
     * @con_length       1
     * @con_is_notnull   true
     */
    protected $show_info_tab = false;
    /**
     * @var bool
     *
     * @con_has_field    true
     * @con_fieldtype    integer
     * @con_length       1
     * @con_is_notnull   true
     */
    protected $mail_notification = false;
    /**
     * @var string
     *
     * @con_has_field    true
     * @con_fieldtype    text
     * @con_length       256
     */
    protected $additional_notification = '';
    /**
     * @var string
     *
     * @con_has_field    true
     * @con_fieldtype    text
     * @con_length       64
     */
    protected $redirect_type = self::REDIRECT_STAY_IN_FORM;
    /**
     * @var string
     *
     * @con_has_field    true
     * @con_fieldtype    text
     * @con_length       256
     */
    protected $redirect_value;
    /**
     * @var string
     *
     * @con_has_field    true
     * @con_fieldtype    text
     * @con_is_notnull   true
     */
    protected $notification_name = "";


    /**
     * @return int
     */
    public function getObjId()
    {
        return $this->obj_id;
    }

    /**
     * @param int $obj_id
     */
    public function setObjId($obj_id)
    {
        $this->obj_id = $obj_id;
    }

    /**
     * @return bool
     */
    public function isOnline()
    {
        return $this->is_online;
    }

    /**
     * @param bool $is_online
     */
    public function setIsOnline($is_online)
    {
        $this->is_online = $is_online;
    }

    /**
     * @return bool
     */
    public function isShowInfoTab()
    {
        return $this->show_info_tab;
    }

    /**
     * @param bool $show_info_tab
     */
    public function setShowInfoTab($show_info_tab)
    {
        $this->show_info_tab = $show_info_tab;
    }

    /**
     * @return bool
     */
    public function hasMailNotification()
    {
        return $this->mail_notification;
    }

    /**
     * @param bool $mail_notification
     */
    public function setMailNotification($mail_notification)
    {
        $this->mail_notification = $mail_notification;
    }

    /**
     * @return string
     */
    public function getAdditionalNotification()
    {
        return $this->additional_notification;
    }

    /**
     * @param string $additional_notification
     */
    public function setAdditionalNotification($additional_notification)
    {
        $this->additional_notification = $additional_notification;
    }



    public function getRedirectType(): string
    {
        return $this->redirect_type ?: self::REDIRECT_STAY_IN_FORM;
    }



    public function setRedirectType(string $redirect_type)
    {
        $this->redirect_type = $redirect_type;
    }



    public function getRedirectValue(): string
    {
        return $this->redirect_value;
    }



    public function setRedirectValue(string $redirect_value)
    {
        $this->redirect_value = $redirect_value;
    }

    /**
     * @return self
     */
    public static function find($primary_key, array $add_constructor_args = [])
    {
        return parent::find($primary_key, $add_constructor_args); // TODO: Change the autogenerated stub
    }



    public function getNotification(): NotificationInterface
    {
        if (empty($this->notification_name)) {
            $this->notification_name = "object_" . $this->getObjId();

            $this->store();
        }

        $notification = self::notifications4plugin()->notifications()->getNotificationByName($this->notification_name);

        if ($notification === null) {
            $notification = self::notifications4plugin()->notifications()->factory()->newInstance();

            $notification->setTitle(self::plugin()->translate("notification"));

            $notification->setName($this->notification_name);

            $notification->setSubject("ILIAS: {{ object.getTitle }}", "default");

            $notification->setText("Sehr geehrte/r {{ user.getFullname }},

Sie haben im Objekt „{{ object.getTitle }}“ die folgenden Angaben ausgewählt:

{% for key, value in user_defined_data %}
{{ key }} : {{ value }}

{% endfor %}
{{ \"now\"|date('d.m.Y H:i') }}", "default");

            self::notifications4plugin()->notifications()->storeNotification($notification);
        }

        return $notification;
    }
}
